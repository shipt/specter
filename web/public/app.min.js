'use strict';/**
 * Config
 */var _slicedToArray=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{!d&&h['return']&&h['return']()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}(),_createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,'value'in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return b&&('object'==typeof b||'function'==typeof b)?b:a}function _inherits(a,b){if('function'!=typeof b&&null!==b)throw new TypeError('Super expression must either be null or a function, not '+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}L.mapbox.accessToken=mpapi;var CHECK_VERSION_TIMEOUT_MS=3e3,RECONNECT_TIMEOUT_MS=3e3,STATUS_COLORS={success:'aqua',clientError:'yellow',serverError:'red'},hqCircleLayer=new L.LayerGroup,circlesLayer=new L.LayerGroup,requestsPerSecCounter=0,hqArray=[],circlesCanvas=L.canvas(),ripplesEl=void 0,trafficSvg=void 0;self.appVersion='',self.debug=!1;/**
 * React (i.e. Presentation Layer)
 */var App=function(a){function b(a){_classCallCheck(this,b);var c=_possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return c.toggleErrorLogger=function(){var a=!c.state.showErrorLogs;!1==a&&c.setState({errorLogs:[]}),c.setState({showErrorLogs:a}),self.debug=a},c.setErrorLog=function(a){c.state.showErrorLogs&&(c.setState(function(b){return{errorLogs:[].concat(_toConsumableArray(b.errorLogs),[a])}}),logger(a))},c.state={errorLogs:[],showErrorLogs:!1,hasError:!1,rpsCount:0,appVersion:'',reconnectTimeoutMs:RECONNECT_TIMEOUT_MS},c}return _inherits(b,a),_createClass(b,[{key:'componentDidMount',value:function b(){var a=this;this.map=L.mapbox.map('map','mapbox.dark',{center:[37.09024,-95.712891],// center on North America
zoom:6}).addLayer(hqCircleLayer).addLayer(circlesLayer),trafficSvg=d3.select(this.map.getPanes().overlayPane).append('svg').attr('class','leaflet-zoom-animated').attr('width',window.innerWidth).attr('height',window.innerHeight),ripplesEl=d3.select(this.map.getPanes().overlayPane).append('ripples').attr('width',window.innerWidth).attr('height',window.innerHeight).call(drawOnCanvas),fetch('package.json').then(function(a){return a.json()}).then(function(b){self.appVersion=b.version,a.setState({appVersion:self.appVersion})}),this.setupWebSocket()}},{key:'setupWebSocket',value:function b(){var a=this;try{var c='https:'===window.location.protocol?'wss:':'ws:';c+='//'+window.location.host,c+=window.location.pathname+'ws',this.ws=new WebSocket(c),this.ws.onmessage=function(b){// exit early if we get bad JSON data
if(''!==b.data){var c=JSON.parse(b.data),d=new L.LatLng(c.SrcLat,c.SrcLong),e=new L.LatLng(c.DstLat,c.DstLong);// exit early if we get strange location data (i.e. from center of the earth to center of the earth)
if((requestsPerSecCounter++,0!==d.lat||0!==d.lng)&&(39.833!==d.lat||-98.585!==d.lng)&&(37.751!==d.lat||-97.822!==d.lng)){var f=a.map.latLngToLayerPoint(d),g=a.map.latLngToLayerPoint(e),h=+c.HTTPStatus,i=calcMidpoint(f,g),j=getStatusColor(h);shouldUpdateHQ(e)&&(addHQCircle(e),hqArray.push(e)),addCircleWithColor(d,j),handleRippleWithColor(f,j),handleTrafficWithColor(f,i,g,j),500<=h&&a.setErrorLog(h+' Error from '+d+' to '+e)}}},this.ws.onopen=function(){a.setErrorLog('WebSocket connected to '+c),a.setState({hasError:!1,reconnectTimeoutMs:RECONNECT_TIMEOUT_MS}),a.requestCounter=setInterval(function(){a.setState(function(){var a=requestsPerSecCounter;return requestsPerSecCounter=0,{rpsCount:a}})},1e3),a.pollVersion=setInterval(function(){return fetchVersionService(a.ws)},CHECK_VERSION_TIMEOUT_MS)},this.ws.onclose=function(){a.setErrorLog('on close callback invoked'),a.setState({hasError:!0}),a.retryWebSocket()},this.ws.onerror=function(){a.setErrorLog('on error callback invoked'),a.setState({hasError:!0})}}catch(a){this.setState({hasError:!0}),this.setErrorLog('caught error: '+a.message),this.retryWebSocket()}}},{key:'retryWebSocket',value:function b(){var a=this;requestsPerSecCounter=0,this.setState({rpsCount:0}),this.setErrorLog('Websocket Terminated. Retrying in '+this.state.reconnectTimeoutMs+'...'),clearInterval(this.requestCounter),clearInterval(this.pollVersion),setTimeout(function(){a.setupWebSocket(),a.setState(function(a){return{reconnectTimeoutMs:a.reconnectTimeoutMs+1e3}})},this.state.reconnectTimeoutMs)}},{key:'render',value:function h(){var a=this.state,b=a.errorLogs,c=a.showErrorLogs,d=a.rpsCount,e=a.appVersion,f=a.hasError,g=a.reconnectTimeoutMs;return[React.createElement('div',{key:'map',id:'map'}),React.createElement(LegendComponent,{key:'legend',onClick:this.toggleErrorLogger,rpsCount:d,isDebugging:c,appVersion:e}),React.createElement(ErrorLoggerComponent,{key:'error-logger',logs:b,show:c}),React.createElement(ReconnectBannerComponent,{key:'error-banner',show:f,reconnectTimeoutMs:g})]}}]),b}(React.PureComponent),LegendComponent=React.memo(function(a){var b=a.onClick,c=a.innerRef,d=a.rpsCount,e=a.isDebugging,f=a.appVersion;return React.createElement('div',{id:'legend',ref:c},React.createElement('div',{style:{float:'right',color:'#888'}},f),React.createElement('h2',null,'HTTP Traffic Status'),React.createElement('div',null,'Data Center: ',React.createElement('span',{style:{color:'white',fontWeight:'bold'}},'white')),React.createElement('div',null,'2xx Success: ',React.createElement('span',{style:{color:STATUS_COLORS.success,fontWeight:'bold'}},STATUS_COLORS.success)),React.createElement('div',null,'4xx Client Error: ',React.createElement('span',{style:{color:STATUS_COLORS.clientError,fontWeight:'bold'}},STATUS_COLORS.clientError)),React.createElement('div',null,'5xx Server Error: ',React.createElement('span',{style:{color:STATUS_COLORS.serverError,fontWeight:'bold'}},STATUS_COLORS.serverError)),React.createElement('div',{style:{float:'right'}},'Requests Per Second: ',d),React.createElement('button',{onClick:b},e?'Disable':'Enable',' Debug Mode'))}),ErrorLoggerComponent=React.memo(function(a){var b=a.logs,c=a.show;return React.createElement('div',{id:'error-logger',style:c?{display:'block'}:{display:'none'}},b.map(function(a,b){return React.createElement('div',{key:b},a)}))}),ReconnectBannerComponent=React.memo(function(a){var b=a.show,c=a.reconnectTimeoutMs;if(!b)return null;var d=React.useState(c/1e3),e=_slicedToArray(d,2),f=e[0],g=e[1];return React.useEffect(function(){var a=setInterval(function(){g(function(a){return a-1})},1e3);return function(){g(c/1e3),clearInterval(a)}},[c]),React.createElement('div',{id:'error-banner'},0>f?'Unable to reconnect. Check your network connection.':'Experiencing network issues. Attempting to reconnect in '+f+'...')});// render app!
ReactDOM.render(React.createElement(App),document.getElementById('app'));/**
 * Helper Functions
 * L.circle - https://leafletjs.com/reference-1.4.0.html#circle
 */function addHQCircle(a){L.circle(a,{renderer:circlesCanvas,radius:5e4,color:'white',fillColor:'white',fillOpacity:.8}).addTo(hqCircleLayer),logger('added HQ location',a)}function addCircleWithColor(a,b){var c=circlesLayer.getLayers();// Only allow 10 circles to be on the map at a time
10<=c.length&&circlesLayer.removeLayer(c[0]),L.circle(a,{renderer:circlesCanvas,radius:5e4,color:b,fillColor:b,fillOpacity:.2}).addTo(circlesLayer)}function handleRippleWithColor(a,b){var c=a.x,d=a.y;ripplesEl.append('ripple').attr('x',c).attr('y',d).attr('r',1e-6).attr('stroke',b).attr('opacity',1).transition().duration(2e3).ease(Math.sqrt).attr('r',35).attr('opacity',1e-6).remove()}function handleTrafficWithColor(a,b,c,d){var e=d3.svg.line().interpolate('basis').x(function(a){return a.x}).y(function(a){return a.y}),f=trafficSvg.append('path').attr('d',e([a,b,c])).attr('stroke-opacity',.8).attr('stroke',d).attr('stroke-width',2).attr('fill','none'),g=f.node().getTotalLength();f.attr('stroke-dasharray',g+' '+g).attr('stroke-dashoffset',g).transition().duration(70).ease('ease-in').attr('stroke-dashoffset',0).each('end',function(){d3.select(this).transition().duration(100).style('stroke-opacity',0).remove()})}function getStatusColor(a){if(400<=a&&500>a)return STATUS_COLORS.clientError;return 500<=a?STATUS_COLORS.serverError:STATUS_COLORS.success}function calcMidpoint(c,d){var e=Math.cos,f=Math.sin,g=Math.sqrt,h=Math.floor,i=c.x,j=c.y,k=d.x,l=d.y,m=[!0,!1],n=m[h(Math.random()*m.length)];if(l<j&&k<i){var o=l,p=k;k=i,l=j,i=p,j=o}else if(l<j){var o=l;l=j,j=o}else if(k<i){var p=k;k=i,i=p}v=k+(i-k),w=l+(j-l);var q=Math.atan(-((l-j)/(k-i))),s=g(k-i)+g(l-j),r=(i+k)/2,t=(j+l)/2,u=parseFloat((Math.random()*5+2.5).toFixed(2));//var min = 1, max = 7;
if(!0===n)var v=h(r-s*u*f(q)),w=h(t-s*u*e(q));else var v=h(r+s*u*f(q)),w=h(t+s*u*e(q));return{x:v,y:w}}function shouldUpdateHQ(a){return!hqArray.some(function(b){return a.lat===b.lat&&a.lng===b.lng})}function logger(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:'';self.debug&&console.log(a,b)}function drawOnCanvas(a){a.each(function(){// For now we only support a circle's ripple effect with strokeStyle.
// But imagine extending this to arbitrary shapes and groups!
function a(a){switch(a.tagName){case'RIPPLE':{d.globalAlpha=a.getAttribute('opacity'),d.strokeStyle=a.getAttribute('stroke'),d.beginPath(),d.arc(a.getAttribute('x'),a.getAttribute('y'),a.getAttribute('r'),0,2*Math.PI),d.stroke();break}}}// Clear the canvas and then iterate over child elements.
var b=this,c=b.parentNode.appendChild(document.createElement('canvas')),d=c.getContext('2d');// It'd be nice to use DOM Mutation Events here instead.
// However, they appear to arrive irregularly, causing choppy animation.
c.style.position='absolute',d3.timer(function(){c.width=b.getAttribute('width'),c.height=b.getAttribute('height');for(var d=b.firstChild;d;d=d.nextSibling)a(d)})})}// uses fetch with a timeout (if connection is lost)
function fetchVersionService(a){var b=!1;new Promise(function(a,c){var d=setTimeout(function(){b=!0,c(new Error('Request timed out'))},CHECK_VERSION_TIMEOUT_MS);fetch('/version',{method:'HEAD'}).then(function(e){if(clearTimeout(d),!b){e.ok||c(new Error('Failed to connect'));// Auto-Refresh on update!
// https://developer.mozilla.org/en-US/docs/Web/API/Location/reload
var f=e.headers.get('Version');self.appVersion!==f&&location.reload(!0),a(e)}}).catch(function(a){// Rejection already happened with setTimeout
b||// Reject with error
c(a)})}).catch(function(b){// since this uses the same service as WS, if this is down, then we've lost connection
// so we should close the WS connection
a.close(),logger('fetchVersionService::'+b.message)})}
