user nginx;
worker_processes auto;
worker_rlimit_nofile 30000;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

include /usr/share/nginx/modules/*.conf;
thread_pool redis threads=8 max_queue=32;
load_module "/etc/nginx/modules/ngx_http_jwt_validation_module.so";
events {
    worker_connections 20000;
}

http {
    include /etc/nginx/blockips.conf;
    include /etc/nginx/jwt_validation_keys.conf;
    log_format  main  '$host $remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" '
                      '"$request_id" "$request_time" "$upstream_response_time" "$upstream_connect_time"' ;
    log_format upstreamlog 'UPSTREAM_LOG - [$time_local] $remote_addr to: $upstream_addr: "$request" proxy_host "$proxy_host" upstream_response_time: '
                      '$upstream_response_time msec: $msec request_time: $request_time' ;

    access_log  /var/log/nginx/access.log  main;
    access_log  /var/log/nginx/access.log  upstreamlog;
    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    server_tokens       off;
    keepalive_timeout   65;
    types_hash_max_size 2048;
    gzip        on;
    gzip_min_length 1000;
    gzip_proxied    any;
    gzip_types
       text/css
       text/javascript
       text/xml
       text/plain
       application/javascript
       application/x-javascript
       application/json;
    ssl_certificate           /opt/bin/cert.crt;
    ssl_certificate_key       /opt/bin/cert.key;
    proxy_set_header        Host $host;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        X-Forwarded-Proto $scheme;
    proxy_redirect      off;
    proxy_read_timeout  60s;
    client_max_body_size 10M;
    large_client_header_buffers 4 16k;
    ssl_session_cache  builtin:1000  shared:SSL:10m;
    ssl_protocols  TLSv1.1 TLSv1.2;
    ssl_ciphers HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4;
    ssl_prefer_server_ciphers on;
    proxy_ssl_server_name  on;
    ssl on;
    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    geo $limit {
        default 1;
        include oauth_token_whitelist.conf;
    }

    map $limit $limit_key {
        0 "";
        1 $binary_remote_addr;
    }

    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    limit_req_zone $limit_key zone=rate_limit:10m rate=1r/s;
    limit_req_log_level notice;

    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        server_tokens   off;
        server_name <%= @shop_server_name %> <%= @member_api_server_name %> <%= @signup_server_name %> <%= @shopper_api_server_name %> <%= @cart_server_name %> <%= @admin_server_name %> <%= @api_server_name %> <%= @envoy_server_name %> <%= @shop_meijer_server_name %>;
        server_name_in_redirect on;
        ssl off;
        location /elb_healthcheck {
          access_log off;
          return 200 'hi';
        }
        location /nginx_status {
          stub_status on;       # enable the status module
          access_log off;
          allow 127.0.0.1;      # allow connections from localhost only
          allow ::1;
          deny all;             # deny every other connection
        }
        location / {
          return 301 https://$host$request_uri;
        }
    }

    server {
        listen       443;
        server_tokens   off;
        server_name  <%= @member_api_server_name %>;
        server_name_in_redirect on;
        resolver <%= @dns_resolver %>;
        include member_api_whitepoints.conf;
        include metropolis_member_api.conf;
        location ~ /api/v1/referral_codes {
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication on;
          proxy_set_header Host <%= @shipt_referendum_upstream %>;
          proxy_ssl_name <%= @shipt_referendum_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_referendum_upstream %>;
          proxy_pass        $upstream_endpoint/v1/referral_codes$is_args$args;
        }
        location ~ ^/api/v1/customers/orders.json {
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication on;
          proxy_set_header Host <%= @shipt_aviator_upstream %>;
          proxy_ssl_name <%= @shipt_aviator_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_aviator_upstream %>;
          proxy_pass         $upstream_endpoint/api/v1/customers/orders.json$is_args$args;
        }
        location ~ ^/api/v1/orders/([0-9]+).json {
          set $new_request_uri $1;
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication on;
          proxy_set_header Host <%= @shipt_aviator_upstream %>;
          proxy_ssl_name <%= @shipt_aviator_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_aviator_upstream %>;
          proxy_pass         $upstream_endpoint/api/v1/orders/$new_request_uri.json$is_args$args;
        }
        location ~ ^/api/v1/orders/([0-9]+)/cancel.json {
          set $new_request_uri $1;
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication on;
          proxy_set_header Host <%= @shipt_aviator_upstream %>;
          proxy_ssl_name <%= @shipt_aviator_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_aviator_upstream %>;
          proxy_pass         $upstream_endpoint/api/v1/orders/$new_request_uri/cancel.json$is_args$args;
        }
        location ~ ^/api/v1/orders/new.json {
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication on;
          proxy_set_header Host <%= @shipt_aviator_upstream %>;
          proxy_ssl_name <%= @shipt_aviator_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_aviator_upstream %>;
          proxy_pass         $upstream_endpoint/api/v1/orders/new.json$is_args$args;
        }
        location ~ ^/api/v1/orders/last.json {
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication on;
          set $proxy_host "";
          set $ssl_name "";
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          if ($request_method = GET ) {
            set $proxy_host <%= @shipt_aviator_upstream %>;
            set $ssl_name <%= @shipt_aviator_upstream %>;
            set $upstream_endpoint https://<%= @shipt_aviator_upstream %>;
            set $pass         $upstream_endpoint/api/v1/orders/last.json$is_args$args;
          }
          if ( $request_method !~ ^GET$ ) {
            set $upstream_endpoint <%= @member_api_upstream %>;
            set $pass          $upstream_endpoint;
          }
          proxy_set_header Host $proxy_host;
          proxy_ssl_name $ssl_name;
          proxy_pass $pass;
        }
        location ~ ^/api/v1/orders/active.json {
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication on;
          set $proxy_host "";
          set $ssl_name "";
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          if ($request_method = GET ) {
            set $proxy_host <%= @shipt_aviator_upstream %>;
            set $ssl_name <%= @shipt_aviator_upstream %>;
            set $upstream_endpoint https://<%= @shipt_aviator_upstream %>;
            set $pass        $upstream_endpoint/api/v1/orders/active.json$is_args$args;
          }
          if ( $request_method !~ ^GET$ ) {
            set $upstream_endpoint <%= @member_api_upstream %>;
            set $pass          $upstream_endpoint;
          }
          proxy_set_header Host $proxy_host;
          proxy_ssl_name $ssl_name;
          proxy_pass $pass;
        }
         location ~ ^/api/v1/orders.json {
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication on;
          set $proxy_host "";
          set $ssl_name "";
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          if ($request_method = POST ) {
            set $proxy_host <%= @shipt_aviator_upstream %>;
            set $ssl_name <%= @shipt_aviator_upstream %>;
            set $upstream_endpoint https://<%= @shipt_aviator_upstream %>;
            set $pass         $upstream_endpoint/api/v1/orders.json$is_args$args;
          }
          if ( $request_method !~ ^POST$ ) {
            set $upstream_endpoint <%= @member_api_upstream %>;
            set $pass          $upstream_endpoint;
          }
          proxy_set_header Host $proxy_host;
          proxy_ssl_name $ssl_name;
          proxy_pass $pass;
        }
        location ~ ^/api/v1/customer_order_line_feedback.json {
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication on;
          proxy_set_header Host <%= @shipt_aviator_upstream %>;
          proxy_ssl_name <%= @shipt_aviator_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_aviator_upstream %>;
          proxy_pass         $upstream_endpoint/api/v1/customer_order_line_feedback.json$is_args$args;
        }
        location ~ ^/api/internal/(.*) {
          return 404;
        }
        location ~ /(.+) {
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication on;
          proxy_set_header Host <%= @member_api_server_name %>;
          proxy_set_header X-Request-Start "t=${msec}";
          set $upstream_endpoint <%= @member_api_upstream %>;
          proxy_pass          $upstream_endpoint;
        }
    }
    server {
        listen       443;
        server_tokens   off;
        server_name  <%= @shopper_api_server_name %>;
        server_name_in_redirect on;
        resolver <%= @dns_resolver %>;
        include shopper_api_whitepoints.conf;
        location ~ /api/v1/shopper/referral_codes {
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication on;
          proxy_set_header Host <%= @shipt_referendum_upstream %>;
          proxy_ssl_name <%= @shipt_referendum_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_referendum_upstream %>;
          proxy_pass        $upstream_endpoint/v1/referral_codes$is_args$args;
        }
        location ~ /api/v1/shopper/pay_periods.json {
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication on;
          set $upstream_endpoint <%= @delivery_history_upstream %>;
          proxy_pass        $upstream_endpoint$is_args$args;
        }
        location ~ /api/v1/shopper/pay_periods/details.json {
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication on;
          set $upstream_endpoint <%= @delivery_history_details_upstream %>;
          proxy_pass        $upstream_endpoint$is_args$args;
        }
        location ~ ^/api/v1/shopper/orders/([0-9]+)/claim.json {
          set $new_request_uri $1;
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication on;
          set $proxy_host "";
          set $ssl_name "";
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $shopper_upstream <%= @shipt_aviator_shopper_upstream %>;
          if ($shopper_upstream = "shipt-aviator.us-east-1.staging.shipt.com" ) {
            set $proxy_host <%= @shipt_aviator_shopper_upstream %>;
            set $ssl_name <%= @shipt_aviator_shopper_upstream %>;
            set $upstream_endpoint https://<%= @shipt_aviator_shopper_upstream %>;
            set $pass         $upstream_endpoint/api/v1/shopper/orders/$new_request_uri/claim.json$is_args$args;
          }
          if ($shopper_upstream = "shipt-aviator.us-west-2.staging.shipt.com" ) {
            set $proxy_host <%= @shipt_aviator_shopper_upstream %>;
            set $ssl_name <%= @shipt_aviator_shopper_upstream %>;
            set $upstream_endpoint https://<%= @shipt_aviator_shopper_upstream %>;
            set $pass         $upstream_endpoint/api/v1/shopper/orders/$new_request_uri/claim.json$is_args$args;
          }
          if ($shopper_upstream = "http://us-east-1.shipt-shopper-api-webserver.production:80" ) {
            set $proxy_host <%= @shopper_api_server_name %>;
            set $upstream_endpoint <%= @shopper_api_upstream %>;
            set $pass          $upstream_endpoint;
          }
          proxy_set_header Host $proxy_host;
          proxy_ssl_name $ssl_name;
          proxy_pass $pass;
        }
        location ~ ^/api/v1/shopper/envoy/deliveries/([0-9]+)/claim.json {
          set $new_request_uri $1;
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication on;
          set $proxy_host "";
          set $ssl_name "";
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $shopper_upstream <%= @shipt_aviator_shopper_upstream %>;
          if ($shopper_upstream = "shipt-aviator.us-east-1.staging.shipt.com" ) {
            set $proxy_host <%= @shipt_aviator_shopper_upstream %>;
            set $ssl_name <%= @shipt_aviator_shopper_upstream %>;
            set $upstream_endpoint https://<%= @shipt_aviator_shopper_upstream %>;
            set $pass         $upstream_endpoint/api/v1/shopper/envoy/deliveries/$new_request_uri/claim.json$is_args$args;
          }
          if ($shopper_upstream = "shipt-aviator.us-west-2.staging.shipt.com" ) {
            set $proxy_host <%= @shipt_aviator_shopper_upstream %>;
            set $ssl_name <%= @shipt_aviator_shopper_upstream %>;
            set $upstream_endpoint https://<%= @shipt_aviator_shopper_upstream %>;
            set $pass         $upstream_endpoint/api/v1/shopper/envoy/deliveries/$new_request_uri/claim.json$is_args$args;
          }
          if ($shopper_upstream = "http://us-east-1.shipt-shopper-api-webserver.production:80" ) {
            set $proxy_host <%= @shopper_api_server_name %>;
            set $upstream_endpoint <%= @shopper_api_upstream %>;
            set $pass          $upstream_endpoint;
          }
          proxy_set_header Host $proxy_host;
          proxy_ssl_name $ssl_name;
          proxy_pass $pass;
        }
        location ~ ^/api/v1/shopper/orders/([0-9]+)/drop.json {
          set $new_request_uri $1;
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication on;
          set $proxy_host "";
          set $ssl_name "";
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $shopper_upstream <%= @shipt_aviator_shopper_upstream %>;
          if ($shopper_upstream = "shipt-aviator.us-east-1.staging.shipt.com" ) {
            set $proxy_host <%= @shipt_aviator_shopper_upstream %>;
            set $ssl_name <%= @shipt_aviator_shopper_upstream %>;
            set $upstream_endpoint https://<%= @shipt_aviator_shopper_upstream %>;
            set $pass         $upstream_endpoint/api/v1/shopper/orders/$new_request_uri/drop.json$is_args$args;
          }
          if ($shopper_upstream = "shipt-aviator.us-west-2.staging.shipt.com" ) {
            set $proxy_host <%= @shipt_aviator_shopper_upstream %>;
            set $ssl_name <%= @shipt_aviator_shopper_upstream %>;
            set $upstream_endpoint https://<%= @shipt_aviator_shopper_upstream %>;
            set $pass         $upstream_endpoint/api/v1/shopper/orders/$new_request_uri/drop.json$is_args$args;
          }
          if ($shopper_upstream = "http://us-east-1.shipt-shopper-api-webserver.production:80" ) {
            set $proxy_host <%= @shopper_api_server_name %>;
            set $upstream_endpoint <%= @shopper_api_upstream %>;
            set $pass          $upstream_endpoint;
          }
          proxy_set_header Host $proxy_host;
          proxy_ssl_name $ssl_name;
          proxy_pass $pass;
        }
        location ~ ^/api/v1/shopper/orders/claimed.json {
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication on;
          set $proxy_host "";
          set $ssl_name "";
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $shopper_upstream <%= @shipt_aviator_shopper_upstream %>;
          if ($shopper_upstream = "shipt-aviator.us-east-1.staging.shipt.com" ) {
            set $proxy_host <%= @shipt_aviator_shopper_upstream %>;
            set $ssl_name <%= @shipt_aviator_shopper_upstream %>;
            set $upstream_endpoint https://<%= @shipt_aviator_shopper_upstream %>;
            set $pass         $upstream_endpoint/api/v1/shopper/orders/claimed.json$is_args$args;
          }
          if ($shopper_upstream = "shipt-aviator.us-west-2.staging.shipt.com" ) {
            set $proxy_host <%= @shipt_aviator_shopper_upstream %>;
            set $ssl_name <%= @shipt_aviator_shopper_upstream %>;
            set $upstream_endpoint https://<%= @shipt_aviator_shopper_upstream %>;
            set $pass         $upstream_endpoint/api/v1/shopper/orders/claimed.json$is_args$args;
          }
          if ($shopper_upstream = "http://us-east-1.shipt-shopper-api-webserver.production:80" ) {
            set $proxy_host <%= @shopper_api_server_name %>;
            set $upstream_endpoint <%= @shopper_api_upstream %>;
            set $pass          $upstream_endpoint;
          }
          proxy_set_header Host $proxy_host;
          proxy_ssl_name $ssl_name;
          proxy_pass $pass;
        }
        location ~ /(.+) {
          limit_except GET POST PATCH PUT DELETE HEAD OPTIONS {
            deny all;
          }
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication on;
          proxy_set_header Host <%= @shopper_api_server_name %>;
          set $upstream_endpoint <%= @shopper_api_upstream %>;
          proxy_pass          $upstream_endpoint;
        }
    }
    server {
        listen       443;
        server_tokens   off;
        server_name  <%= @admin_server_name %>;
        server_name_in_redirect on;
        resolver <%= @dns_resolver %>;
        location / {
          include cors_support.conf;
          jwt_validation off;
          legacy_authentication off;
          set $upstream_endpoint <%= @admin_upstream %>;
          proxy_pass          $upstream_endpoint;
          proxy_buffer_size          128k;
          proxy_buffers              4 256k;
          proxy_busy_buffers_size    256k;
        }
    }
    server {
        listen       443;
        server_tokens   off;
        server_name  <%= @cart_server_name %>;
        server_name_in_redirect on;
        resolver <%= @dns_resolver %>;
        location / {
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication on;
          proxy_set_header Host <%= @cart_upstream %>;
          proxy_ssl_name <%= @cart_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @cart_upstream %>;
          proxy_pass          $upstream_endpoint;
        }
    }
    server {
        listen       443;
        server_tokens   off;
        server_name  <%= @shop_server_name %>;
        server_name_in_redirect on;
        resolver <%= @dns_resolver %>;
        location / {
          include cors_support.conf;
          jwt_validation off;
          legacy_authentication off;
          set $upstream_endpoint <%= @shop_upstream %>;
          proxy_pass          $upstream_endpoint;
        }
    }
    server {
        listen       443;
        server_tokens   off;
        server_name  <%= @signup_server_name %>;
        server_name_in_redirect on;
        resolver <%= @dns_resolver %>;
        location / {
          include cors_support.conf;
          jwt_validation off;
          legacy_authentication off;
          proxy_set_header Host <%= @signup_host %>;
          set $upstream_endpoint <%= @signup_upstream %>;
          proxy_pass          $upstream_endpoint;
        }
    }
    server {
        listen       443;
        server_tokens   off;
        server_name  <%= @envoy_server_name %>;
        server_name_in_redirect on;
        resolver <%= @dns_resolver %>;
        location ~ ^.*/api/v1/.* {
          return 403 'api/v1 endpoints are not accessible to public';
        }
        location / {
          jwt_validation off;
          legacy_authentication off ;
          proxy_set_header Host <%= @envoy_server_name %>;
          set $upstream_endpoint <%= @envoy_upstream %>;
          proxy_pass          $upstream_endpoint;
        }
    }
    server {
        listen       443;
        server_tokens   off;
        server_name  <%= @shop_meijer_server_name %>;
        server_name_in_redirect on;
        resolver <%= @dns_resolver %>;
        location / {
          jwt_validation off;
          legacy_authentication off ;
          proxy_set_header Host www.shipt.com;
          set $upstream_endpoint <%= @shop_meijer_home_upstream %>;
          proxy_pass          $upstream_endpoint;
        }
    }
    server {
        listen       443;
        server_tokens   off;
        server_name  <%= @card_server_name %>;
        server_name_in_redirect on;
        resolver <%= @dns_resolver %>;
        location ~ ^/shipt-card/v1/shoppers/([0-9]+)/transactions/recent {
          set $new_request_uri $1;
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication off;
          proxy_set_header Host <%= @shipt_card_upstream %>;
          proxy_ssl_name <%= @shipt_card_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_card_upstream %>;
          proxy_pass          $upstream_endpoint/v1/shoppers/$new_request_uri/transactions/recent;
        }
        location ~ ^/shipt-card/v1/shoppers {
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication off;
          proxy_set_header Host <%= @shipt_card_upstream %>;
          proxy_ssl_name <%= @shipt_card_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_card_upstream %>;
          proxy_pass          $upstream_endpoint/v1/shoppers;
        }
        location ~ ^/shipt-card/v1/authorize/Authorization {
          include cors_support.conf;
          jwt_validation off;
          legacy_authentication off;
          proxy_set_header Host <%= @shipt_card_upstream %>;
          proxy_ssl_name <%= @shipt_card_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_card_upstream %>;
          proxy_pass          $upstream_endpoint/v1/authorize/Authorization;
        }
        location ~ ^/shipt-card/v1/Authorization {
          include cors_support.conf;
          jwt_validation off;
          legacy_authentication off;
          proxy_set_header Host <%= @shipt_card_upstream %>;
          proxy_ssl_name <%= @shipt_card_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_card_upstream %>;
          proxy_pass          $upstream_endpoint/v1/Authorization;
        }
        location ~ ^/shipt-card/v1/Settlement {
          include cors_support.conf;
          jwt_validation off;
          legacy_authentication off;
          proxy_set_header Host <%= @shipt_card_upstream %>;
          proxy_ssl_name <%= @shipt_card_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_card_upstream %>;
          proxy_pass          $upstream_endpoint/v1/Settlement;
        }
        location ~ ^/shipt-card/v1/AccountEvent {
          include cors_support.conf;
          jwt_validation off;
          legacy_authentication off;
          proxy_set_header Host <%= @shipt_card_upstream %>;
          proxy_ssl_name <%= @shipt_card_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_card_upstream %>;
          proxy_pass          $upstream_endpoint/v1/AccountEvent;
        }
        location ~ ^/shipt-card/v1/Transaction {
          include cors_support.conf;
          jwt_validation off;
          legacy_authentication off;
          proxy_set_header Host <%= @shipt_card_upstream %>;
          proxy_ssl_name <%= @shipt_card_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_card_upstream %>;
          proxy_pass          $upstream_endpoint/v1/Transaction;
        }
        location ~ ^/shipt-card/v1/pex/authorizations {
          include cors_support.conf;
          jwt_validation off;
          legacy_authentication off;
          proxy_set_header Host <%= @shipt_card_upstream %>;
          proxy_ssl_name <%= @shipt_card_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_card_upstream %>;
          proxy_pass          $upstream_endpoint/v1/pex/authorizations;
        }
        location ~ ^/shipt-card/v1/pex/webhooks/(.*) {
          set $new_request_uri $1;
          include cors_support.conf;
          jwt_validation off;
          legacy_authentication off;
          proxy_set_header Host <%= @shipt_card_upstream %>;
          proxy_ssl_name <%= @shipt_card_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_card_upstream %>;
          proxy_pass          $upstream_endpoint/v1/pex/webhooks/$new_request_uri$is_args$args;
        }
        location ~ ^/shipt-card-wedge/v1/shoppers/([0-9]+)/transactions/recent {
          set $new_request_uri $1;
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication off;
          proxy_set_header Host <%= @shipt_card_upstream %>;
          proxy_ssl_name <%= @shipt_card_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_card_upstream %>;
          proxy_pass          $upstream_endpoint/v1/shoppers/$new_request_uri/transactions/recent;
        }
        location ~ ^/shipt-card-wedge/v1/shoppers {
          include cors_support.conf;
          jwt_validation on;
          legacy_authentication off;
          proxy_set_header Host <%= @shipt_card_upstream %>;
          proxy_ssl_name <%= @shipt_card_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_card_upstream %>;
          proxy_pass          $upstream_endpoint/v1/shoppers;
        }
        location ~ ^/shipt-card-wedge/v1/authorize/Authorization {
          include cors_support.conf;
          jwt_validation off;
          legacy_authentication off;
          proxy_set_header Host <%= @shipt_card_upstream %>;
          proxy_ssl_name <%= @shipt_card_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_card_upstream %>;
          proxy_pass          $upstream_endpoint/v1/authorize/Authorization;
        }
        location ~ ^/shipt-card-wedge/v1/Authorization {
          include cors_support.conf;
          jwt_validation off;
          legacy_authentication off;
          proxy_set_header Host <%= @shipt_card_upstream %>;
          proxy_ssl_name <%= @shipt_card_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_card_upstream %>;
          proxy_pass          $upstream_endpoint/v1/Authorization;
        }
        location ~ ^/shipt-card-wedge/v1/Settlement {
          include cors_support.conf;
          jwt_validation off;
          legacy_authentication off;
          proxy_set_header Host <%= @shipt_card_upstream %>;
          proxy_ssl_name <%= @shipt_card_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_card_upstream %>;
          proxy_pass          $upstream_endpoint/v1/Settlement;
        }
        location ~ ^/shipt-card-wedge/v1/AccountEvent {
          include cors_support.conf;
          jwt_validation off;
          legacy_authentication off;
          proxy_set_header Host <%= @shipt_card_upstream %>;
          proxy_ssl_name <%= @shipt_card_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_card_upstream %>;
          proxy_pass          $upstream_endpoint/v1/AccountEvent;
        }
        location ~ ^/shipt-card-wedge/v1/Transaction {
          include cors_support.conf;
          jwt_validation off;
          legacy_authentication off;
          proxy_set_header Host <%= @shipt_card_upstream %>;
          proxy_ssl_name <%= @shipt_card_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_card_upstream %>;
          proxy_pass          $upstream_endpoint/v1/Transaction;
        }
        location ~ ^/shipt-card-wedge/v1/pex/authorizations {
          include cors_support.conf;
          jwt_validation off;
          legacy_authentication off;
          proxy_set_header Host <%= @shipt_card_upstream %>;
          proxy_ssl_name <%= @shipt_card_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_card_upstream %>;
          proxy_pass          $upstream_endpoint/v1/pex/authorizations;
        }
        location ~ ^/shipt-card-wedge/v1/pex/webhooks/(.*) {
          set $new_request_uri $1;
          include cors_support.conf;
          jwt_validation off;
          legacy_authentication off;
          proxy_set_header Host <%= @shipt_card_upstream %>;
          proxy_ssl_name <%= @shipt_card_upstream %>;
          proxy_ssl_session_reuse on;
          proxy_buffering off;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          set $upstream_endpoint https://<%= @shipt_card_upstream %>;
          proxy_pass          $upstream_endpoint/v1/pex/webhooks/$new_request_uri$is_args$args;
        }
    }
    include pomona_test_harness.conf;
    server {
      listen      443;
      server_tokens   off;
      server_name <%= @api_server_name %> <%= @api_server_name_alias %>;
      server_name_in_redirect on;
      resolver <%= @dns_resolver %>;
      location ~ whoami {
        return 404;
      }
      location ~ ^/search/(.*) {
        set $new_request_uri $1;
        include cors_support.conf;
        jwt_validation off;
        legacy_authentication off;
        proxy_set_header Host <%= @search_upstream %>;
        proxy_ssl_name <%= @search_upstream %>;
        proxy_ssl_session_reuse on;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        set $upstream_endpoint https://<%= @search_upstream %>;
        proxy_set_header Client_IP $http_x_forwarded_for;
        proxy_pass        $upstream_endpoint/$new_request_uri$is_args$args;
      }
      location /tag/js/resource.js {
        add_header "Cache-Control" "max-age=0, no-cache, no-store, must-revalidate";
        proxy_pass https://s3.amazonaws.com/api.shipt.com/resource.js;
      }
      location ~ ^/autocomplete/(.*) {
        set $new_request_uri $1;
        include cors_support.conf;
        jwt_validation on;
        legacy_authentication off;
        proxy_set_header Host <%= @autocomplete_upstream%>;
        proxy_ssl_name <%= @autocomplete_upstream%>;
        proxy_ssl_session_reuse on;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        set $upstream_endpoint https://<%= @autocomplete_upstream %>;
        proxy_pass        $upstream_endpoint/$new_request_uri$is_args$args;
      }
      include auth_whitepoints.conf;
      location ~ ^/auth/(.+) {
        set $new_request_uri $1;
        include cors_support.conf;
        jwt_validation on;
        legacy_authentication on;
        set $upstream_endpoint <%= @auth_upstream %>;
       proxy_pass        $upstream_endpoint/$new_request_uri$is_args$args;
      }
      location ~ ^/adzuki/(.*) {
        set $new_request_uri $1;
        include cors_support.conf;
        jwt_validation off;
        legacy_authentication off;
        proxy_set_header Host <%= @adzuki_upstream %>;
        proxy_ssl_name <%= @adzuki_upstream %>;
        proxy_ssl_session_reuse on;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        set $upstream_endpoint https://<%= @adzuki_upstream %>;
        proxy_pass        $upstream_endpoint/$new_request_uri$is_args$args;
      }
      location ~ ^/pearl/(.*) {
        set $new_request_uri $1;
        jwt_validation off;
        legacy_authentication off;
        proxy_set_header Host <%= @pearl_host %>;
        set $upstream_endpoint <%= @pearl_upstream %>;
        proxy_pass        $upstream_endpoint/$new_request_uri$is_args$args;
      }
      location ~ ^/content/(.+) {
        set $new_request_uri $1;
        include cors_support.conf;
        jwt_validation off;
        legacy_authentication off;
        proxy_set_header Host <%= @valhalla_upstream %>;
        proxy_ssl_name <%= @valhalla_upstream %>;
        proxy_ssl_session_reuse on;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        set $upstream_endpoint https://<%= @valhalla_upstream %>;
        proxy_pass        $upstream_endpoint/$new_request_uri$is_args$args;
      }
      location ~ ^/shelves/(.+) {
        set $new_request_uri $1;
        include cors_support.conf;
        include wildcard_cors_support.conf;
        jwt_validation off;
        legacy_authentication off;
        proxy_set_header Host <%= @urchin_upstream %>;
        proxy_ssl_name <%= @urchin_upstream %>;
        proxy_ssl_session_reuse on;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        set $upstream_endpoint https://<%= @urchin_upstream %>;
        proxy_pass        $upstream_endpoint/$new_request_uri$is_args$args;
      }
      location ~ ^/recommendations/(.+) {
        set $new_request_uri $1;
        include cors_support.conf;
        jwt_validation off;
        legacy_authentication off;
        proxy_set_header Host <%= @recommendations_upstream %>;
        proxy_ssl_name <%= @recommendations_upstream %>;
        proxy_ssl_session_reuse on;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        set $upstream_endpoint https://<%= @recommendations_upstream %>;
        proxy_pass        $upstream_endpoint/$new_request_uri$is_args$args;
      }
      location ~ ^/barcodes/(.+) {
        set $new_request_uri $1;
        include cors_support.conf;
        jwt_validation on;
        legacy_authentication on;
        set $upstream_endpoint <%= @barcodes_upstream %>;
        proxy_pass        $upstream_endpoint/$new_request_uri$is_args$args;
      }
      include phs_whitepoints.conf;
      location ~ ^/purchase-history/(.+) {
        set $new_request_uri $1;
        include cors_support.conf;
        jwt_validation on;
        proxy_set_header Host <%= @purchase_history_upstream %>;
        proxy_ssl_name <%= @purchase_history_upstream %>;
        proxy_ssl_session_reuse on;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        set $upstream_endpoint https://<%= @purchase_history_upstream %>;
        proxy_pass        $upstream_endpoint/$new_request_uri$is_args$args;
      }
      include signup_promotions_whitepoints.conf;
      location ~ ^/stripe-sync/(.+) {
        set $new_request_uri $1;
        include cors_support.conf;
        jwt_validation off;
        legacy_authentication off;
        proxy_set_header Host <%= @stripe_sync_upstream %>;
        proxy_ssl_name <%= @stripe_sync_upstream %>;
        proxy_ssl_session_reuse on;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        set $upstream_endpoint https://<%= @stripe_sync_upstream %>;
        proxy_pass        $upstream_endpoint/$new_request_uri$is_args$args;
      }
      include cart_whitepoints.conf;
      location ~ ^/cart/(.+) {
        set $new_request_uri $1;
        include cors_support.conf;
        jwt_validation on;
        legacy_authentication on;
        proxy_set_header Host <%= @cart_upstream %>;
        proxy_ssl_name <%= @cart_upstream %>;
        proxy_ssl_session_reuse on;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        set $upstream_endpoint https://<%= @cart_upstream %>;
        proxy_pass        $upstream_endpoint/$new_request_uri$is_args$args;
        }
      location ~ ^/prism/(.+) {
        set $new_request_uri $1;
        include cors_support.conf;
        jwt_validation on;
        legacy_authentication on;
        set $upstream_endpoint <%= @prism_upstream %>;
        proxy_pass        $upstream_endpoint/$new_request_uri$is_args$args;
      }
      location ~ ^/semaphore/(.+) {
        set $new_request_uri $1;
        include cors_support.conf;
        jwt_validation on;
        legacy_authentication off;
        set $upstream_endpoint <%= @shipt_semaphore_upstream %>;
        proxy_pass        $upstream_endpoint/$new_request_uri$is_args$args;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
      }
      location ~ ^/banners/(.+) {
        set $new_request_uri $1;
        include cors_support.conf;
        jwt_validation off;
        legacy_authentication off;
        proxy_set_header Host <%= @shipt_banners_upstream %>;
        proxy_ssl_name <%= @shipt_banners_upstream %>;
        proxy_ssl_session_reuse on;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        set $upstream_endpoint https://<%= @shipt_banners_upstream %>;
        proxy_pass        $upstream_endpoint/$new_request_uri$is_args$args;
      }
      location ~ ^/aviator/(.+) {
        set $new_request_uri $1;
        jwt_validation on;
        legacy_authentication on;
        proxy_set_header Host <%= @shipt_aviator_upstream %>;
        proxy_ssl_name <%= @shipt_aviator_upstream %>;
        proxy_ssl_session_reuse on;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        set $upstream_endpoint https://<%= @shipt_aviator_upstream %>;
        proxy_pass        $upstream_endpoint/$new_request_uri$is_args$args;
      }
      location /v1/codes/validate {
        jwt_validation off;
        legacy_authentication off;
        proxy_set_header Host <%= @codex_upstream %>;
        proxy_ssl_name <%= @codex_upstream %>;
        proxy_ssl_session_reuse on;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        set $upstream_endpoint https://<%= @codex_upstream %>;
        proxy_pass        $upstream_endpoint/v1/codes/validate$is_args$args;
      }
      location /referendum/v1/referral_codes {
        include cors_support.conf;
        jwt_validation on;
        legacy_authentication on;
        proxy_set_header Host <%= @shipt_referendum_upstream %>;
        proxy_ssl_name <%= @shipt_referendum_upstream %>;
        proxy_ssl_session_reuse on;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        set $upstream_endpoint https://<%= @shipt_referendum_upstream %>;
        proxy_pass        $upstream_endpoint/v1/referral_codes$is_args$args;
      }
      include special_requests_service.conf;
      ## start: shipt-ops managed api gateway locations
      include shipt_memberships_api_whitepoints.conf;
      include shipt_memberships_api.conf;
      include crm.conf;
      include shipt_delivery_windows_api_whitepoints.conf;
      include shipt_delivery_windows_api.conf;
      include shipt_orders_api_whitepoints.conf;
      include shipt_orders_api.conf;
      include shipt_shopper_feedback_api_whitepoints.conf;
      include shipt_shopper_feedback_api.conf;
      include shipt_shopper_pay.conf;
      include shipt_offer_service.conf;
      include shipt_shopping_list.conf;
      include shopper_settings.conf;
      include black_list_all_api_docs.conf;
      include blacklist_debug_pprof.conf;
      include feature_promotions.conf;
      include favorites.conf;
      include experimentation.conf;
      include categories.conf;
      include autopilot.conf;
      include anon_comms.conf;
      include metropolis.conf;
      include shipt_credits.conf;
      ## end: shipt-ops managed api gateway locations
   }
}